# Snowflake SQL Queries Reference

## Data Modification Queries

### Update Store Opening Dates
```sql
-- Update all stores to have opening dates after 1/1/2014
UPDATE DimStoreData
SET StoreOpeningDate = DATEADD(DAY, UNIFORM(0, 3600, RANDOM()), DATE '2014-01-01');
```

### Update Recent Store Openings
```sql
-- Update stores with ID between 91-100 to have opened in the last 12 months
UPDATE DimStoreData
SET StoreOpeningDate = DATEADD(DAY, UNIFORM(0, 360, RANDOM()), DATE '2023-01-01')
WHERE STOREID between 91 and 100;
```

### Update Customer Age Restriction
```sql
-- Ensure all customers are at least 12 years old
UPDATE DIMCUSTOMER 
SET DOB = DATEADD(YEAR,-12,DOB)
WHERE DOB >= DATEADD(YEAR,-12,'2024-01-01');
```

### Fix Invalid Order Dates
```sql
-- Fix orders with dates before store opening
UPDATE FACTORDERS F 
SET F.DATEID = R.DATEID FROM
(SELECT 
    O.OrderID, 
    D2.DATEID 
FROM (
    SELECT 
        F.OrderID,
        DATEADD(
            DAY, 
            DATEDIFF(DAY, S.STOREOPENINGDATE, '2024-01-01') * UNIFORM(1, 10, RANDOM()) * 0.1,
            S.STOREOPENINGDATE
        ) AS newdate
    FROM FACTORDERS F
    JOIN DIMDATE D ON F.DATEID = D.DATEID
    JOIN DIMSTOREDATA S ON F.STOREID = S.STOREID
    WHERE D.DATE < S.STOREOPENINGDATE
) O
JOIN DIMDATE D2 ON O.newdate = D2.DATE) R
WHERE F.ORDERID = R.ORDERID;
```

## Customer Analysis Queries

### Inactive Customers
```sql
-- Find customers who haven't placed an order in the last 30 days
SELECT * FROM DIMCUSTOMER C 
WHERE C.CUSTOMERID NOT IN (
    SELECT DISTINCT C.CUSTOMERID 
    FROM DIMCUSTOMER C
    JOIN FACTORDERS F ON C.CUSTOMERID = F.CUSTOMERID
    JOIN DIMDATE D ON F.DATEID = D.DATEID
    WHERE D.DATE >= DATEADD(MONTH, -1, '2024-01-01')
);
```

### Multi-Category Customers
```sql
-- Find customers who ordered from more than 3 categories in the last 6 months
WITH BD AS (
    SELECT F.CUSTOMERID, P.CATEGORY 
    FROM FACTORDERS F
    JOIN DIMDATE D ON F.DATEID = D.DATEID
    JOIN DIMPRODUCTDATA P ON F.PRODUCTID = P.PRODUCTID
    WHERE D.DATE >= DATEADD(MONTH, -6, '2024-01-01')
    GROUP BY F.CUSTOMERID, P.CATEGORY
)

SELECT CUSTOMERID FROM BD
GROUP BY CUSTOMERID
HAVING COUNT(DISTINCT CATEGORY) > 3;
```

### Top Discount Customer
```sql
-- Find the customer who has taken the maximum discount in their lifetime
SELECT CUSTOMERID, SUM(DISCOUNTAMOUNT) AS DIA 
FROM FACTORDERS F 
GROUP BY CUSTOMERID
ORDER BY DIA DESC 
LIMIT 1;
```

### Customer with Most Orders
```sql
-- List the customer who has placed maximum number of orders
WITH BASEDA AS (
    SELECT CUSTOMERID, COUNT(ORDERID) AS OC
    FROM FACTORDERS F
    GROUP BY CUSTOMERID
),
ORDATA AS (
    SELECT B.*, ROW_NUMBER() OVER (ORDER BY OC DESC) AS ORD
    FROM BASEDA B
)
SELECT * 
FROM ORDATA 
WHERE ORD = 1;
```

### Loyalty Program Analysis
```sql
-- Share customer count by loyalty program status
SELECT L.PROGRAMTIER, COUNT(CUSTOMERID) 
FROM DIMCUSTOMER D 
JOIN DIMLOYALTYINFO L ON D.LOYALTYINFOID = L.LOYALTYINFOID
GROUP BY L.PROGRAMTIER;
```

### Loyalty Program Revenue
```sql
-- List total amount for each loyalty program tier since 2023
SELECT L.PROGRAMNAME, SUM(TOTALAMOUNT) AS TS 
FROM FACTORDERS F
JOIN DIMDATE D ON F.DATEID = D.DATEID
JOIN DIMCUSTOMER C ON F.CUSTOMERID = C.CUSTOMERID
JOIN DIMLOYALTYINFO L ON C.LOYALTYINFOID = L.LOYALTYINFOID
WHERE D.YEAR >= 2023
GROUP BY L.PROGRAMNAME;
```

## Store & Sales Analysis

### Most Recently Opened Store
```sql
-- List the most recently opened store with its sales
WITH store_rank AS (
    SELECT 
        STOREID, 
        STOREOPENINGDATE,
        ROW_NUMBER() OVER (ORDER BY STOREOPENINGDATE DESC) AS FRANK 
    FROM DIMSTOREDATA
),
recent AS (
    SELECT STOREID 
    FROM store_rank 
    WHERE FRANK = 1
),
STOREAMOUNT AS (
    SELECT 
        o.STOREID, 
        SUM(o.TOTALAMOUNT) AS TOTAL_SALES
    FROM FACTORDERS o
    JOIN recent s ON o.STOREID = s.STOREID
    GROUP BY o.STOREID
)
SELECT * FROM DIMSTOREDATA S 
JOIN STOREAMOUNT A ON S.STOREID = A.STOREID;
```

### Monthly Sales
```sql
-- Get monthly total sales for the current year
SELECT D.MONTH, SUM(F.TOTALAMOUNT) 
FROM FACTORDERS F
JOIN DIMDATE D ON F.DATEID = D.DATEID
WHERE D.YEAR = 2024
GROUP BY D.MONTH
ORDER BY D.MONTH;
```

### Manager Revenue
```sql
-- Calculate revenue generated by each store manager in June 2024
SELECT C.MANAGERNAME, SUM(TOTALAMOUNT) AS TS 
FROM FACTORDERS F
JOIN DIMDATE D ON F.DATEID = D.DATEID
JOIN DIMSTOREDATA C ON F.STOREID = C.STOREID
WHERE D.YEAR = 2023 AND D.MONTH = 6
GROUP BY C.MANAGERNAME;
```

### Store Average Order
```sql
-- List average order amount per store for 2023
SELECT C.STORENAME, C.STORETYPE, AVG(TOTALAMOUNT) AS TS 
FROM FACTORDERS F
JOIN DIMDATE D ON F.DATEID = D.DATEID
JOIN DIMSTOREDATA C ON F.STOREID = C.STOREID
WHERE D.YEAR = 2023 
GROUP BY C.STORENAME, C.STORETYPE;
```

### Regional Category Sales
```sql
-- Show region/category total sales for the last 6 months
SELECT REGION, CATEGORY, SUM(TOTALAMOUNT) AS TOTSALES 
FROM FACTORDERS F
JOIN DIMDATE D ON F.DATEID = D.DATEID
JOIN DIMPRODUCTDATA P ON F.PRODUCTID = P.PRODUCTID
JOIN DIMSTOREDATA S ON F.STOREID = S.STOREID
WHERE D.DATE >= DATEADD(MONTH,-6,'2024-01-01')
GROUP BY REGION, CATEGORY;
```

## Product Analysis

### Highest Discount
```sql
-- Find the highest discount given on any order in the last year
WITH BS AS (
    SELECT 
        F.*,
        ROW_NUMBER() OVER (ORDER BY F.DISCOUNTAMOUNT DESC) AS DRANK
    FROM FACTORDERS F
    JOIN DIMDATE D ON F.DATEID = D.DATEID
    WHERE D.DATE >= DATEADD(YEAR, -1, '2024-01-01')
)
SELECT *
FROM BS
WHERE DRANK = 1;
```

### Total Unit Price Sales
```sql
-- Calculate total sales based on unit price and quantity
SELECT SUM(QUANTITYORDERED * UNITPRICE) AS TOTALSALES 
FROM FACTORDERS F
JOIN DIMPRODUCTDATA P ON F.PRODUCTID = P.PRODUCTID;
```

### Top Brands
```sql
-- Top 3 brands based on sales in the last year
WITH BRANDSALES AS (
    SELECT P.BRANDNAME, SUM(F.TOTALAMOUNT) AS TOTALSALES 
    FROM FACTORDERS F 
    JOIN DIMDATE D ON F.DATEID = D.DATEID
    JOIN DIMPRODUCTDATA P ON F.PRODUCTID = P.PRODUCTID
    WHERE D.DATE >= DATEADD(YEAR, -1, '2024-01-01')
    GROUP BY P.BRANDNAME
),
BRANDSALESRANK AS (
    SELECT S.*, ROW_NUMBER() OVER (ORDER BY TOTALSALES DESC) AS SR
    FROM BRANDSALES S
)
SELECT * 
FROM BRANDSALESRANK 
WHERE SR <= 3;
```

### Top Products by Quantity
```sql
-- Show top 5 products based on quantity ordered in the last 3 years
WITH QUANT AS (
    SELECT F.PRODUCTID, SUM(QUANTITYORDERED) AS TOT
    FROM FACTORDERS F 
    JOIN DIMDATE D ON F.DATEID = D.DATEID
    WHERE D.DATE >= DATEADD(YEAR, -3, '2024-01-01')
    GROUP BY F.PRODUCTID
),
QUANTRANK AS (
    SELECT Q.PRODUCTID, Q.TOT, 
           ROW_NUMBER() OVER (ORDER BY Q.TOT DESC) AS QUANTWISE
    FROM QUANT Q
)
SELECT PRODUCTID, TOT
FROM QUANTRANK 
WHERE QUANTWISE <= 5;
```

### Pricing Impact Analysis
```sql
-- Check if new pricing structure would increase total amount
SELECT CASE 
    WHEN SUM(ORDERAMOUNT - ORDERAMOUNT * 0.05 - ORDERAMOUNT * 0.08) > SUM(TOTALAMOUNT) 
    THEN 'YES' ELSE 'NO'
    END 
FROM FACTORDERS F 
LIMIT 10;
```

## External File Operations

### Read Customer Data
```sql
-- Query data from customer CSV file in stage
SELECT $1, $2, $3
FROM @"testdb"."testschema".teststage/DimCustomerData/DimCustomerData.csv
(FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT');
```

### Count Records
```sql
-- Count records in customer file from stage
SELECT count($1)
FROM @"testdb"."testschema".teststage/DimCustomerData/DimCustomerData.csv
(FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT');
```

### Filter External Data
```sql
-- Filter data from DimCustomer file with birth date 2000-01-01
SELECT $1, $2, $3, $4, $5, $6
FROM @"testdb"."testschema".teststage/DimCustomerData/DimCustomerData.csv
(FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT')
WHERE $4 = '2000-01-01';
```

### Join External Files
```sql
-- Join customer and loyalty data to show program tiers
WITH customerdata AS (
  SELECT $1 AS firstt, $12 AS loyalid 
  FROM @"testdb"."testschema".teststage/DimCustomerData/DimCustomerData.csv
  (FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT')
),
ldata AS (
  SELECT $1 AS lid, $3 AS pt 
  FROM @"testdb"."testschema".teststage/DimLoyaltyInfo/DimLoyaltyInfo.csv
  (FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT')
)
SELECT firstt, pt 
FROM customerdata c 
JOIN ldata l ON c.loyalid = l.lid;
```

### Group By from External Files
```sql
-- Count customers by program tier from external files
WITH customerdata AS (
  SELECT $1 AS firstt, $12 AS loyalid 
  FROM @"testdb"."testschema".teststage/DimCustomerData/DimCustomerData.csv
  (FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT')
),
ldata AS (
  SELECT $1 AS lid, $3 AS pt 
  FROM @"testdb"."testschema".teststage/DimLoyaltyInfo/DimLoyaltyInfo.csv
  (FILE_FORMAT => 'CSV_SOURCE_FILE_FORMAT')
)
SELECT l.pt, COUNT(*) AS TotalCount 
FROM customerdata c 
JOIN ldata l ON c.loyalid = l.lid
GROUP BY l.pt;
```